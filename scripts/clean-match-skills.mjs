// scripts/clean-match-skills.mjs
import fs from "node:fs";
import path from "node:path";
import url from "node:url";

// === 読み込み元/書き出し先 ===
const ROOT = path.dirname(url.fileURLToPath(import.meta.url));
const SRC  = path.resolve(ROOT, "../src/data/matchSkills.js");
const OUT  = path.resolve(ROOT, "../src/data/matchSkills.cleaned.js");

// === 非破壊クレンジング ===
function cleanVisibleText(input) {
  if (input == null) return input;

  let s = String(input);

  // 1) HTMLタグ除去（データに混入した <br> 等の最低限対策）
  s = s.replace(/<[^>]*>/g, "");

  // 2) ゼロ幅・バリアントセレクタ等の不可視文字を除去
  //    - ZWSP/ZWNJ/ZWJ/FEFF/VS-Selectors 等
  s = s.replace(/[\u200B-\u200D\uFEFF\uFE00-\uFE0F]/g, "");

  // 3) 各種「見た目が空白」のUnicodeスペースを通常スペースへ
  //    NBSP, En/Em/Thin space, NNBSP, Ideographic space(全角空白)など
  s = s.replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g, " ");

  // 4) 改行を \n に統一
  s = s.replace(/\r\n?/g, "\n");

  // 5) 連続スペースやタブを縮約（段落内のみ）
  s = s.replace(/[ \t]{2,}/g, " ");

  // 6) 行頭末尾の余分な空白を削除（本文は維持）
  s = s.split("\n").map(line => line.trimEnd()).join("\n").trim();

  return s;
}

function cleanRecord(rec) {
  // name/detail は最重要。その他の自由項目に触らない。
  const out = { ...rec };
  if ("name"   in out) out.name   = cleanVisibleText(out.name);
  if ("detail" in out) out.detail = cleanVisibleText(out.detail);

  // シート由来でたまに文字列化される null/"null" を正規化（安全な範囲）
  for (let i = 1; i <= 5; i++) {
    const tk = `target${i}`;
    const ak = `activator${i}`;
    if (out[tk] === "null") out[tk] = null;
    if (out[ak] === "null") out[ak] = null;
  }
  return out;
}

// === 既存 JS を安全に eval せず読み込む：export const matchSkills = [...] 形式をパース
const source = fs.readFileSync(SRC, "utf8");
const m = source.match(/export\s+const\s+matchSkills\s*=\s*(\[[\s\S]*\]);?/);
if (!m) {
  console.error("matchSkills 配列を src/data/matchSkills.js から抽出できません。フォーマットを確認してください。");
  process.exit(1);
}

// 配列部分だけを JSON として読める形に近づける（末尾カンマ等に注意）
let arrayText = m[1]
  // 許容されていれば「キー省略オブジェクト」の安全化（万一に備えて軽めに）：
  .replace(/(\w+)\s*:/g, '"$1":') // key: → "key":
  .replace(/(['"])?([A-Z]\d{3}-\d{2})(\1)?/g, '"$2"'); // B001-03 等の裸IDを文字列に（過剰一致しない程度に）

// JSON.parse に通らなければ、Functionコンストラクタで ESM 的に評価（安全性のために sandbox 風）
let records;
try {
  records = JSON.parse(arrayText);
} catch {
  // eslint-disable-next-line no-new-func
  const arr = new Function(`return (${m[1]});`)();
  records = Array.isArray(arr) ? arr : [];
}

const before = records.length;
const cleaned = records.map(cleanRecord);

// 出力
const banner =
  "// AUTO-GENERATED by scripts/clean-match-skills.mjs\n" +
  "// 非破壊クレンジング済みのデータです。編集せず、元データを修正→再生成してください。\n";

const outText =
  `${banner}export const matchSkills = ${JSON.stringify(cleaned, null, 2)};\n`;

fs.writeFileSync(OUT, outText, "utf8");

console.log(`Cleaned matchSkills: ${before} → ${cleaned.length}`);
console.log(`Wrote: ${path.relative(process.cwd(), OUT)}`);
